#!/usr/bin/env bash

set -eo pipefail
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
BUILD_DIR=$1
CLEAN_FILES=.slug-post-clean
source $BIN_DIR/utils

puts-step "Cleaning up...."
if [[ ! -n "${BUILD_DIR}" ]]; then
  puts-step "No build directory specified - exiting"
  exit 1
fi

cd ${BUILD_DIR}

if [[ ! -f "${CLEAN_FILES}" ]]; then
  puts-step "Could not find .slug-post-clean file - exiting"
  exit 1
fi

while read file; do
  puts-step "Test ${file}"
  [[ ! -n "${file}" ]] && continue

  if [[ -f "${file}" ]]; then
    puts-step "Removing file ${file} from slug"
    rm -f ${file}
  elif [[ -d "${file}" ]]; then
    puts-step "Removing directory ${file} from slug"
    deep-rm -rf ${file}
  else
    puts-step "Location ${file} not found - ignoring"
  fi
done <${CLEAN_FILES}
